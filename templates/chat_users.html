<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chat Users and Courses</title>
  </head>
  {% extends "base.html" %} {% block title %} Raydex Hub - Chat{% endblock %} {%
  block content %}
  <link
    href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css"
    rel="stylesheet"
  />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
  <style>
    .chat-list::-webkit-scrollbar {
      width: 6px;
    }
    .chat-list::-webkit-scrollbar-thumb {
      background-color: #4a5568;
      border-radius: 3px;
    }
    .online-indicator {
      width: 10px;
      height: 10px;
      background-color: #68d391;
      border-radius: 50%;
      display: inline-block;
    }
    .unread-indicator {
      width: 20px;
      height: 20px;
      background-color: #68d391;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 12px;
      font-weight: bold;
    }
  </style>
  <body class="bg-gray-100">
    <div class="container mx-auto px-4 py-8">
      <div
        class="max-w-md mx-auto bg-white rounded-lg shadow-lg overflow-hidden"
      >
        <div class="bg-green-500 text-white p-4">
          <h1 class="text-2xl font-bold">Chats</h1>
        </div>
        <div class="p-4">
          <input
            type="text"
            id="search-input"
            placeholder="Search chats"
            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"
          />
        </div>
        <div class="flex border-b border-gray-200">
          <button
            id="users-tab"
            class="flex-1 py-2 px-4 text-center font-semibold text-green-500 border-b-2 border-green-500"
          >
            Users
          </button>
          <button
            id="courses-tab"
            class="flex-1 py-2 px-4 text-center font-semibold text-gray-500"
          >
            Courses
          </button>
        </div>
        <div id="users-list" class="chat-list overflow-y-auto h-96">
          <!-- Users will be dynamically inserted here -->
        </div>
        <div id="courses-list" class="chat-list overflow-y-auto h-96 hidden">
          <!-- Courses will be dynamically inserted here -->
        </div>
      </div>
    </div>

    <script>
      const socket = io();
      const currentUser = "{{ current_user.username }}";
      const usersList = document.getElementById("users-list");
      const coursesList = document.getElementById("courses-list");
      const searchInput = document.getElementById("search-input");
      const usersTab = document.getElementById("users-tab");
      const coursesTab = document.getElementById("courses-tab");
      const onlineUsers = new Set();
      const unreadMessages = {};

      socket.emit("join", { room: "users_list" });
      socket.emit("request_online_users");

      socket.on("user_connected", function (data) {
        onlineUsers.add(data.username);
        updateUserStatus(data.username, true);
      });

      socket.on("user_disconnected", function (data) {
        onlineUsers.delete(data.username);
        updateUserStatus(data.username, false);
      });

      socket.on("online_users_list", function (data) {
        data.users.forEach((username) => {
          onlineUsers.add(username);
          updateUserStatus(username, true);
        });
      });

      socket.on("new_message", function (data) {
        if (data.sender !== currentUser) {
          if (data.course_id) {
            incrementUnreadCount("course_" + data.course_id);
          } else {
            incrementUnreadCount(data.sender);
          }
        }
      });

      function updateUserStatus(username, isOnline) {
        const userElement = document.querySelector(
          `[data-chat-id="${username}"]`
        );
        if (userElement) {
          const statusIndicator =
            userElement.querySelector(".online-indicator");
          statusIndicator.style.display = isOnline ? "inline-block" : "none";
        }
      }

      function incrementUnreadCount(identifier) {
        unreadMessages[identifier] = (unreadMessages[identifier] || 0) + 1;
        updateUnreadIndicator(identifier);
      }

      function updateUnreadIndicator(identifier) {
        const element = document.querySelector(
          `[data-chat-id="${identifier}"]`
        );
        if (element) {
          const unreadIndicator = element.querySelector(".unread-indicator");
          const count = unreadMessages[identifier] || 0;
          unreadIndicator.textContent = count;
          unreadIndicator.style.display = count > 0 ? "flex" : "none";
        }
      }

      function createChatElement(item, isUser = true) {
        const div = document.createElement("div");
        div.className =
          "flex items-center justify-between p-4 border-b border-gray-200 hover:bg-gray-100 cursor-pointer";
        div.setAttribute(
          "data-chat-id",
          isUser ? item.username : `course_${item.id}`
        );
        div.innerHTML = `
                <div class="flex items-center">
                    <img src="${
                      isUser
                        ? "https://via.placeholder.com/40"
                        : "https://via.placeholder.com/40/4CAF50/FFFFFF?text=C"
                    }" alt="${
          isUser ? item.username : item.title
        }" class="w-10 h-10 rounded-full mr-3">
                    <div>
                        <h2 class="font-semibold">${
                          isUser ? item.username : item.title
                        }</h2>
                        <p class="text-sm text-gray-500">${
                          isUser ? item.email : "Course Chat"
                        }</p>
                    </div>
                </div>
                <div class="flex items-center">
                    ${
                      isUser
                        ? '<span class="online-indicator mr-2" style="display: none;"></span>'
                        : ""
                    }
                    <span class="unread-indicator" style="display: none;">0</span>
                </div>
            `;
        div.addEventListener("click", () => {
          if (isUser) {
            window.location.href = `/chat/${item.id}`;
          } else {
            window.location.href = `/course/${item.id}/chat`;
          }
        });
        return div;
      }

      // Fetch users and populate the list
      fetch("/api/users")
        .then((response) => response.json())
        .then((users) => {
          users.forEach((user) => {
            if (user.username !== currentUser) {
              const userElement = createChatElement(user);
              usersList.appendChild(userElement);
              updateUserStatus(user.username, onlineUsers.has(user.username));
              updateUnreadIndicator(user.username);
            }
          });
        });

      // Fetch courses and populate the list
      fetch("/api/courses")
        .then((response) => response.json())
        .then((courses) => {
          courses.forEach((course) => {
            const courseElement = createChatElement(course, false);
            coursesList.appendChild(courseElement);
            updateUnreadIndicator(`course_${course.id}`);
          });
        });

      // Search functionality
      searchInput.addEventListener("input", function (e) {
        const searchTerm = e.target.value.toLowerCase();
        const chatItems = document.querySelectorAll("[data-chat-id]");

        chatItems.forEach((element) => {
          const chatName = element
            .querySelector("h2")
            .textContent.toLowerCase();
          const chatInfo = element.querySelector("p").textContent.toLowerCase();

          if (chatName.includes(searchTerm) || chatInfo.includes(searchTerm)) {
            element.style.display = "flex";
          } else {
            element.style.display = "none";
          }
        });
      });

      // Tab switching
      usersTab.addEventListener("click", function () {
        usersTab.classList.add(
          "text-green-500",
          "border-b-2",
          "border-green-500"
        );
        coursesTab.classList.remove(
          "text-green-500",
          "border-b-2",
          "border-green-500"
        );
        coursesTab.classList.add("text-gray-500");
        usersList.classList.remove("hidden");
        coursesList.classList.add("hidden");
      });

      coursesTab.addEventListener("click", function () {
        coursesTab.classList.add(
          "text-green-500",
          "border-b-2",
          "border-green-500"
        );
        usersTab.classList.remove(
          "text-green-500",
          "border-b-2",
          "border-green-500"
        );
        usersTab.classList.add("text-gray-500");
        coursesList.classList.remove("hidden");
        usersList.classList.add("hidden");
      });
    </script>
  </body>
</html>
{% endblock%}
