{% extends "base_chat.html" %} {% block title %}Chat with {{ user.username }}{%
endblock %} {% block content %}
<div class="container mx-auto px-4 py-6">
  <div class="bg-white rounded-lg shadow-lg p-4 chat-container">
    <h2 class="text-2xl font-bold text-blue-600 mb-4">
      Chat with {{ user.username }}
    </h2>

    <div class="messages-container">
      {% for message in messages %}
      <div
        class="flex {% if message.sender_id == current_user.id %}justify-end{% endif %} mb-4"
      >
        <div
          class="message-bubble {% if message.sender_id == current_user.id %}message-bubble-right{% else %}message-bubble-left{% endif %}"
        >
          <div class="text-sm opacity-75 mb-1">
            {{ message.sender.username }}
          </div>
          {{ message.content }}
          <div class="text-xs opacity-75 mt-1">
            {{ message.timestamp.strftime('%H:%M') }}
          </div>
        </div>
      </div>
      {% endfor %}
    </div>

    <div class="typing-indicator mt-2 mb-2" style="display: none">
      <span id="typing-username"></span> is typing...
    </div>

    <div class="mt-4">
      <form id="message-form" class="flex space-x-2">
        <input
          type="text"
          id="message-input"
          class="flex-1 border border-gray-300 rounded-full px-4 py-2 focus:outline-none focus:border-blue-500"
          placeholder="Type your message..."
        />
        <button
          type="submit"
          class="bg-blue-600 text-white rounded-full px-6 py-2 hover:bg-blue-700 transition duration-200"
        >
          Send
        </button>
      </form>
    </div>
  </div>
</div>
{% endblock %} {% block scripts %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const socket = io();
    const currentUser = "{{ current_user.username }}";
    const recipientId = "{{ user.id }}";
    const roomId = `private_${Math.min({{ current_user.id }}, {{ user.id }})}_${Math.max({{ current_user.id }}, {{ user.id }})}`;
    let typingTimeout;

    // Join private room
    socket.emit("join", { room: roomId });

    // Handle message form submission
    document.getElementById("message-form").addEventListener("submit", function (e) {
      e.preventDefault();
      const input = document.getElementById("message-input");
      const content = input.value.trim();

      if (content) {
        socket.emit("message", { room: roomId, type: "private", msg: content, recipient_id: recipientId });
        input.value = "";
      }
    });

    // Handle typing
    document.getElementById("message-input").addEventListener("keyup", function () {
      socket.emit("typing", { room: roomId });
      clearTimeout(typingTimeout);
      typingTimeout = setTimeout(() => {
        socket.emit("stop_typing", { room: roomId });
      }, 1000);
    });

    // Handle incoming messages
    socket.on("message", function (data) {
      const messagesContainer = document.querySelector(".messages-container");
      const messageDiv = document.createElement("div");
      const isCurrentUser = data.username === currentUser;

      messageDiv.className = `flex ${isCurrentUser ? "justify-end" : ""} mb-4 animate__animated animate__fadeIn`;
      messageDiv.innerHTML = `
        <div class="message-bubble ${isCurrentUser ? "message-bubble-right" : "message-bubble-left"}">
          <div class="text-sm opacity-75 mb-1">${data.username}</div>
          ${data.msg}
          <div class="text-xs opacity-75 mt-1">${new Date().toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })}</div>
        </div>
      `;

      messagesContainer.appendChild(messageDiv);
      messagesContainer.scrollTop = messagesContainer.scrollHeight;
    });

    // Handle typing indicators
    socket.on("typing", function (data) {
      if (data.username !== currentUser) {
        const typingIndicator = document.querySelector(".typing-indicator");
        const typingUsername = document.getElementById("typing-username");
        typingUsername.textContent = data.username;
        typingIndicator.style.display = "inline-block";
      }
    });

    socket.on("stop_typing", function (data) {
      if (data.username !== currentUser) {
        const typingIndicator = document.querySelector(".typing-indicator");
        typingIndicator.style.display = "none";
      }
    });

    // Initial scroll to bottom
    const messagesContainer = document.querySelector(".messages-container");
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
  });
</script>
{% endblock %}
